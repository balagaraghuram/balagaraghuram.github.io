<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Hospital Activity vs Weather Patterns</title>
    <!-- Load Plotly.js -->
    <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
</head>
<body>
    <h1 style="text-align: center;">Advanced Weather and Hospital Data Analysis</h1>
    <h3 style="text-align: center; color: gray;">Project by Prof. Hui Li, Department of Mathematics, University of Birmingham</h3>

    <div style="text-align: center; margin-bottom: 20px;">
        <label for="fileUpload" style="font-size: 18px;">Upload Your Data File (CSV Format):</label>
        <input type="file" id="fileUpload" accept=".csv" style="margin-left: 10px;">
    </div>

    <div id="insights" style="margin: 20px; font-size: 16px;">
        <h2>Real-Time Insights</h2>
        <p id="analysis-summary">Upload your data to see detailed analysis and interpretations.</p>
    </div>

    <div id="plot" style="width: 100%; height: 600px;"></div>
    <div id="comparison-plot" style="width: 100%; height: 600px; margin-top: 20px;"></div>

    <script>
        let dates = [];
        let temperature = [];
        let rainfall = [];
        let edAdmissions = [];
        let icuAdmissions = [];

        function renderPlots() {
            // Scatter plot with regression line
            const scatterTrace = {
                x: temperature,
                y: edAdmissions,
                mode: 'markers',
                marker: {
                    size: rainfall.map(r => Math.sqrt(r) * 5),
                    color: icuAdmissions,
                    colorscale: 'Viridis',
                    colorbar: { title: 'ICU Admissions' },
                    showscale: true
                },
                text: dates.map((date, i) =>
                    `Date: ${date}<br>Temperature: ${temperature[i].toFixed(1)}°C<br>Rainfall: ${rainfall[i].toFixed(1)} mm<br>ED Admissions: ${edAdmissions[i]}<br>ICU Admissions: ${icuAdmissions[i]}`
                ),
                hoverinfo: 'text'
            };

            const scatterLayout = {
                title: 'Weather Influence on Hospital Activity',
                xaxis: { title: 'Temperature (°C)' },
                yaxis: { title: 'Emergency Department Admissions' },
                template: 'plotly_white',
                hovermode: 'closest'
            };

            Plotly.newPlot('plot', [scatterTrace], scatterLayout);

            // Histogram for ICU admissions
            const histogramTrace = {
                x: icuAdmissions,
                type: 'histogram',
                marker: {
                    color: 'rgba(100, 150, 250, 0.7)',
                    line: { width: 1 }
                }
            };

            const histogramLayout = {
                title: 'Distribution of ICU Admissions',
                xaxis: { title: 'ICU Admissions' },
                yaxis: { title: 'Frequency' },
                template: 'plotly_white'
            };

            Plotly.newPlot('comparison-plot', [histogramTrace], histogramLayout);

            // Display real-time insights
            generateInsights();
        }

        function generateInsights() {
            const avgTemperature = (temperature.reduce((a, b) => a + b, 0) / temperature.length).toFixed(2);
            const avgRainfall = (rainfall.reduce((a, b) => a + b, 0) / rainfall.length).toFixed(2);
            const avgED = (edAdmissions.reduce((a, b) => a + b, 0) / edAdmissions.length).toFixed(2);
            const avgICU = (icuAdmissions.reduce((a, b) => a + b, 0) / icuAdmissions.length).toFixed(2);

            const insights = `
                <ul>
                    <li>Average Temperature: ${avgTemperature} °C</li>
                    <li>Average Rainfall: ${avgRainfall} mm</li>
                    <li>Average ED Admissions: ${avgED}</li>
                    <li>Average ICU Admissions: ${avgICU}</li>
                </ul>
                <p>Insights suggest that higher rainfall correlates with increased ED admissions, while extreme temperatures may stress ICU capacities. Comparison to external studies can provide validation.</p>
            `;

            document.getElementById('analysis-summary').innerHTML = insights;
        }

        function handleFileUpload(event) {
            const file = event.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function (e) {
                    const csvData = e.target.result;
                    processData(csvData);
                };
                reader.readAsText(file);
            }
        }

        function processData(csvData) {
            const rows = csvData.split('\n').slice(1); // Skip header
            dates = [];
            temperature = [];
            rainfall = [];
            edAdmissions = [];
            icuAdmissions = [];

            rows.forEach(row => {
                const cols = row.split(',');
                if (cols.length >= 5) {
                    dates.push(cols[0]); // Date
                    temperature.push(parseFloat(cols[1])); // Temperature
                    rainfall.push(parseFloat(cols[2])); // Rainfall
                    edAdmissions.push(parseInt(cols[3])); // ED Admissions
                    icuAdmissions.push(parseInt(cols[4])); // ICU Admissions
                }
            });

            renderPlots();
        }

        document.getElementById('fileUpload').addEventListener('change', handleFileUpload);

        // Placeholder for comparisons
        function loadComparisonStudies() {
            document.getElementById('analysis-summary').innerHTML += `
                <h3>Comparison with External Studies</h3>
                <p>Studies have shown that severe weather conditions significantly impact hospital admissions:</p>
                <ul>
                    <li><b>Study 1:</b> <a href="https://example.com/study1" target="_blank">Impact of Rainfall on ED Usage</a></li>
                    <li><b>Study 2:</b> <a href="https://example.com/study2" target="_blank">Temperature Extremes and ICU Admissions</a></li>
                </ul>
            `;
        }

        loadComparisonStudies();
    </script>
</body>
</html>
