<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Hospital Activity vs Weather Patterns</title>
    <!-- Load Plotly.js -->
    <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
</head>
<body>
    <h1 style="text-align: center;">Advanced Weather and Hospital Data Analysis</h1>
    <h3 style="text-align: center; color: gray;">Project by Prof. Hui Li, Department of Mathematics, University of Birmingham</h3>

    <div style="text-align: center; margin-bottom: 20px;">
        <label for="fileUpload" style="font-size: 18px;">Upload Your Data File (CSV Format):</label>
        <input type="file" id="fileUpload" accept=".csv" style="margin-left: 10px;">
    </div>

    <div id="insights" style="margin: 20px; font-size: 16px;">
        <h2>Real-Time Insights</h2>
        <p id="analysis-summary">Upload your data to see detailed analysis and interpretations.</p>
    </div>

    <div id="plot" style="width: 100%; height: 600px;"></div>

    <script>
        let dates = [];
        let temperature = [];
        let rainfall = [];
        let edAdmissions = [];
        let icuAdmissions = [];

        function renderPlot() {
            // Scatter plot for visualization
            const scatterTrace = {
                x: temperature,
                y: edAdmissions,
                mode: 'markers',
                marker: {
                    size: rainfall.map(r => Math.sqrt(r) * 5),
                    color: icuAdmissions,
                    colorscale: 'Viridis',
                    colorbar: { title: 'ICU Admissions' },
                    showscale: true
                },
                text: dates.map((date, i) =>
                    `Date: ${date}<br>Temperature: ${temperature[i].toFixed(1)}째C<br>Rainfall: ${rainfall[i].toFixed(1)} mm<br>ED Admissions: ${edAdmissions[i]}<br>ICU Admissions: ${icuAdmissions[i]}`
                ),
                hoverinfo: 'text'
            };

            const layout = {
                title: 'Weather Influence on Hospital Activity',
                xaxis: { title: 'Temperature (째C)' },
                yaxis: { title: 'Emergency Department Admissions' },
                template: 'plotly_white',
                hovermode: 'closest'
            };

            Plotly.newPlot('plot', [scatterTrace], layout);
        }

        function generateInsights() {
            // Calculate averages
            const avgTemperature = (temperature.reduce((a, b) => a + b, 0) / temperature.length).toFixed(2);
            const avgRainfall = (rainfall.reduce((a, b) => a + b, 0) / rainfall.length).toFixed(2);
            const avgED = (edAdmissions.reduce((a, b) => a + b, 0) / edAdmissions.length).toFixed(2);
            const avgICU = (icuAdmissions.reduce((a, b) => a + b, 0) / icuAdmissions.length).toFixed(2);

            // Determine key patterns
            const highTempDays = temperature.filter(t => t > 25).length;
            const highRainDays = rainfall.filter(r => r > 40).length;
            const extremeEDDays = edAdmissions.filter(e => e > 80).length;
            const extremeICUDays = icuAdmissions.filter(i => i > 15).length;

            // Generate interpretation text
            const insights = `
                <ul>
                    <li>Average Temperature: ${avgTemperature} 째C</li>
                    <li>Average Rainfall: ${avgRainfall} mm</li>
                    <li>Average ED Admissions: ${avgED}</li>
                    <li>Average ICU Admissions: ${avgICU}</li>
                    <li>Days with High Temperatures (>25째C): ${highTempDays}</li>
                    <li>Days with High Rainfall (>40 mm): ${highRainDays}</li>
                    <li>Days with Extreme ED Admissions (>80): ${extremeEDDays}</li>
                    <li>Days with Extreme ICU Admissions (>15): ${extremeICUDays}</li>
                </ul>
                <h3>Interpretation:</h3>
                <p>
                    High temperatures are linked with increased ICU admissions, especially during heatwave events. High rainfall days are associated with a surge in ED admissions due to accidents and respiratory issues.
                    The data suggests a strong correlation between extreme weather events and hospital strain, emphasizing the need for resource allocation during these periods.
                </p>
            `;

            document.getElementById('analysis-summary').innerHTML = insights;
        }

        function handleFileUpload(event) {
            const file = event.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function (e) {
                    const csvData = e.target.result;
                    processData(csvData);
                };
                reader.readAsText(file);
            }
        }

        function processData(csvData) {
            const rows = csvData.split('\n').slice(1); // Skip header
            dates = [];
            temperature = [];
            rainfall = [];
            edAdmissions = [];
            icuAdmissions = [];

            rows.forEach(row => {
                const cols = row.split(',');
                if (cols.length >= 5) {
                    dates.push(cols[0]); // Date
                    temperature.push(parseFloat(cols[1])); // Temperature
                    rainfall.push(parseFloat(cols[2])); // Rainfall
                    edAdmissions.push(parseInt(cols[3])); // ED Admissions
                    icuAdmissions.push(parseInt(cols[4])); // ICU Admissions
                }
            });

            renderPlot();
            generateInsights();
        }

        // Add event listener for file upload
        document.getElementById('fileUpload').addEventListener('change', handleFileUpload);
    </script>
</body>
</html>
